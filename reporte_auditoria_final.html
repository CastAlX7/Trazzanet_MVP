<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Estratégico - TrazzaNet</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Fuentes e Iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Configuración Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        trazza: {
                            bg: '#011c16',      
                            card: 'rgba(255, 255, 255, 0.03)',
                            border: 'rgba(255, 255, 255, 0.05)',
                            primary: '#10B981', 
                            glow: '#34D399',    
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #011c16;
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(16, 185, 129, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 100% 100%, rgba(6, 78, 59, 0.1) 0%, transparent 40%);
            min-height: 100vh;
            color: #e2e8f0;
            overflow-x: hidden;
        }

        .grid-bg {
            position: fixed;
            inset: 0;
            background-image: 
                linear-gradient(rgba(16, 185, 129, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(16, 185, 129, 0.02) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: -1;
            pointer-events: none;
        }

        /* Glassmorphism */
        .glass-panel {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .glass-panel:hover {
            border-color: rgba(16, 185, 129, 0.2);
            box-shadow: 0 10px 40px -10px rgba(16, 185, 129, 0.1);
            transform: translateY(-2px);
        }

        /* Sidebar Styles */
        .sidebar {
            width: 5rem;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(1, 28, 22, 0.9);
            backdrop-filter: blur(15px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            overflow: hidden;
            white-space: nowrap;
            z-index: 50;
        }
        .sidebar:hover { width: 18rem; }
        .sidebar-text {
            opacity: 0;
            transform: translateX(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
        }
        .sidebar:hover .sidebar-text {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
            transition-delay: 0.1s;
        }
        .nav-link {
            position: relative;
            display: flex;
            align-items: center;
            height: 3.5rem;
            padding: 0 1.25rem;
            color: #94a3b8;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        .nav-link:hover, .nav-link.active {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.1) 0%, transparent 100%);
            color: #10B981;
        }
        .nav-link.active { border-left-color: #10B981; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: rgba(16, 185, 129, 0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(16, 185, 129, 0.4); }

        /* KPI Card Specifics */
        .kpi-icon-wrapper {
            transition: all 0.3s ease;
        }
        .glass-panel:hover .kpi-icon-wrapper {
            transform: scale(1.1) rotate(5deg);
        }
    </style>
</head>

<body class="flex">

    <div class="grid-bg"></div>

    <!-- SIDEBAR -->
    <aside class="sidebar h-screen fixed left-0 top-0 flex flex-col justify-between shadow-2xl">
        <div>
            <div class="h-20 flex items-center px-5 relative border-b border-white/5">
                <div class="w-10 h-10 min-w-[2.5rem] flex items-center justify-center bg-emerald-900/30 rounded-lg border border-emerald-500/30 text-emerald-400">
                    <svg class="w-6 h-6" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M50 8 L88 28 V72 L50 92 L12 72 V28 L50 8Z" stroke="currentColor" stroke-width="8" fill="none"/>
                        <circle cx="50" cy="50" r="12" fill="currentColor"/>
                    </svg>
                </div>
                <div class="sidebar-text ml-3">
                    <h1 class="text-lg font-bold text-white tracking-wide">Trazza<span class="text-emerald-400">Net</span></h1>
                    <p class="text-[0.6rem] text-gray-400 uppercase tracking-widest">Blockchain System

</p>
                </div>
            </div>

            <nav class="mt-6 space-y-1">
                <a href="dashboard.html" class="nav-link group">
                    <i class="fas fa-tachometer-alt group-hover:text-emerald-400 transition-colors"></i>
                    <span class="sidebar-text ml-4 font-medium text-sm">Dashboard</span>
                </a>
                <a href="carga.html" class="nav-link group">
                    <i class="fas fa-upload group-hover:text-emerald-400 transition-colors"></i>
                    <span class="sidebar-text ml-4 font-medium text-sm">Carga de Datos</span>
                </a>
                <a href="trazabilidad.html" class="nav-link group">
                    <i class="fas fa-project-diagram group-hover:text-emerald-400 transition-colors"></i>
                    <span class="sidebar-text ml-4 font-medium text-sm">Trazabilidad</span>
                </a>
                <a href="auditoria.html" class="nav-link group">
                    <i class="fas fa-clipboard-check group-hover:text-emerald-400 transition-colors"></i>
                    <span class="sidebar-text ml-4 font-medium text-sm">Auditoría</span>
                </a>
                
                <!-- Active Link -->
                <a href="reporte_auditoria_final.html" class="nav-link active">
                    <i class="fas fa-chart-line text-emerald-400"></i>
                    <span class="sidebar-text ml-4 font-medium text-sm text-white">Análisis Estratégico</span>
                </a>
                
                <a href="blockchain.html" class="nav-link group">
                    <i class="fas fa-link group-hover:text-emerald-400 transition-colors"></i>
                    <span class="sidebar-text ml-4 font-medium text-sm">Blockchain</span>
                </a>
            </nav>
        </div>

        <div class="p-4 border-t border-white/5">
            <div class="flex items-center overflow-hidden">
                <div class="w-10 h-10 min-w-[2.5rem] rounded-full bg-gradient-to-br from-emerald-600 to-teal-800 flex items-center justify-center text-white font-bold text-xs shadow-lg border border-emerald-400/20">
                    <i class="fas fa-user"></i>
                </div>
                <div class="sidebar-text ml-3">
                    <p class="text-sm font-medium text-white truncate">Usuario Activo</p>
                    <p class="text-xs text-emerald-500 truncate" id="user-id-display">Cargando...</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 ml-20 p-8 lg:p-12 transition-all duration-300">
        
        <!-- Header -->
        <div class="mb-10 animate-[fadeIn_0.5s_ease-out]">
            <h1 class="text-4xl font-bold text-white mb-2 tracking-tight">Análisis Estratégico de Auditoría</h1>
            <p class="text-gray-400 text-lg">Reporte consolidado de conformidad y tendencias de calidad en Blockchain.</p>
        </div>

        <!-- Filter Controls -->
        <div class="glass-panel p-6 rounded-2xl mb-8 flex flex-col md:flex-row justify-between items-center gap-6 animate-[fadeIn_0.6s_ease-out]">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-emerald-900/30 rounded-xl flex items-center justify-center shadow-lg border border-emerald-500/20">
                    <i class="fas fa-filter text-emerald-400 text-xl"></i>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-white">Filtros de Análisis</h2>
                    <p class="text-sm text-gray-500">Selecciona el alcance del reporte</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4 w-full md:w-auto">
                <label for="filterSelect" class="text-sm font-semibold text-gray-400 whitespace-nowrap">Filtrar por:</label>
                <div class="relative w-full">
                    <select id="filterSelect" class="w-full appearance-none bg-[#011c16] border border-emerald-500/30 text-white py-2 px-4 pr-8 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500/50 hover:bg-emerald-900/10 transition-colors cursor-pointer">
                        <option value="Global">Global (Todos)</option>
                        <option value="SemanaActual">Esta Semana</option>
                        <option value="MesActual">Este Mes</option>
                        <option value="Conformes">Solo Conformes</option>
                        <option value="Hallazgos">Con Hallazgos</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-emerald-500">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
                <button class="bg-emerald-600 hover:bg-emerald-500 text-white p-2 rounded-lg transition-colors shadow-lg shadow-emerald-900/20" title="Actualizar">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- KPI 1 -->
            <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-emerald-500/10 rounded-full blur-xl group-hover:bg-emerald-500/20 transition-all"></div>
                <div class="flex justify-between items-start mb-4">
                    <div class="kpi-icon-wrapper w-12 h-12 bg-emerald-500/10 rounded-xl flex items-center justify-center text-emerald-400 border border-emerald-500/20">
                        <i class="fas fa-check-circle text-xl"></i>
                    </div>
                    <span class="text-xs font-bold text-emerald-400 bg-emerald-500/10 px-2 py-1 rounded-full border border-emerald-500/20">
                        <i class="fas fa-arrow-up mr-1"></i>IA Analysis
                    </span>
                </div>
                <h3 class="text-sm font-semibold text-gray-400 mb-1">Tasa de Conformidad</h3>
                <p id="kpi-conformidad" class="text-3xl font-bold text-white mb-1">--%</p>
                <p class="text-xs text-gray-500">Promedio global calculado</p>
            </div>

            <!-- KPI 2 -->
            <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-red-500/10 rounded-full blur-xl group-hover:bg-red-500/20 transition-all"></div>
                <div class="flex justify-between items-start mb-4">
                    <div class="kpi-icon-wrapper w-12 h-12 bg-red-500/10 rounded-xl flex items-center justify-center text-red-400 border border-red-500/20">
                        <i class="fas fa-times-circle text-xl"></i>
                    </div>
                    <span class="text-xs font-bold text-red-400 bg-red-500/10 px-2 py-1 rounded-full border border-red-500/20">
                        <i class="fas fa-exclamation mr-1"></i>Crítico
                    </span>
                </div>
                <h3 class="text-sm font-semibold text-gray-400 mb-1">Lotes Rechazados</h3>
                <p id="kpi-rechazados" class="text-3xl font-bold text-white mb-1">--</p>
                <p class="text-xs text-gray-500">Requieren disposición final</p>
            </div>

            <!-- KPI 3 -->
            <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-yellow-500/10 rounded-full blur-xl group-hover:bg-yellow-500/20 transition-all"></div>
                <div class="flex justify-between items-start mb-4">
                    <div class="kpi-icon-wrapper w-12 h-12 bg-yellow-500/10 rounded-xl flex items-center justify-center text-yellow-400 border border-yellow-500/20">
                        <i class="fas fa-exclamation-triangle text-xl"></i>
                    </div>
                </div>
                <h3 class="text-sm font-semibold text-gray-400 mb-1">Con Hallazgos</h3>
                <p id="kpi-hallazgos" class="text-3xl font-bold text-white mb-1">--</p>
                <p class="text-xs text-gray-500">Alertas de calidad media</p>
            </div>

            <!-- KPI 4 -->
            <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-500/10 rounded-full blur-xl group-hover:bg-blue-500/20 transition-all"></div>
                <div class="flex justify-between items-start mb-4">
                    <div class="kpi-icon-wrapper w-12 h-12 bg-blue-500/10 rounded-xl flex items-center justify-center text-blue-400 border border-blue-500/20">
                        <i class="fas fa-boxes text-xl"></i>
                    </div>
                </div>
                <h3 class="text-sm font-semibold text-gray-400 mb-1">Total Auditorías</h3>
                <p id="kpi-total" class="text-3xl font-bold text-white mb-1">--</p>
                <p class="text-xs text-gray-500">Registros en Blockchain</p>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Tendencia Mensual Chart -->
            <div class="glass-panel p-6 rounded-2xl">
                <div class="flex items-center gap-3 mb-6 border-b border-white/5 pb-4">
                    <div class="w-10 h-10 bg-emerald-900/30 rounded-lg flex items-center justify-center text-emerald-400">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-white">Evolución de Conformidad</h2>
                        <p class="text-xs text-gray-400">Tendencia histórica de lotes aprobados</p>
                    </div>
                </div>
                <div class="relative h-64">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Causas de Falla Chart -->
            <div class="glass-panel p-6 rounded-2xl">
                <div class="flex items-center gap-3 mb-6 border-b border-white/5 pb-4">
                    <div class="w-10 h-10 bg-orange-900/30 rounded-lg flex items-center justify-center text-orange-400">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-white">Distribución de Resultados</h2>
                        <p class="text-xs text-gray-400">Proporción de estados de auditoría</p>
                    </div>
                </div>
                <div class="relative h-64 flex justify-center">
                    <canvas id="breakdownChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Insights Section -->
        <div class="glass-panel p-8 rounded-2xl shadow-2xl relative overflow-hidden border-emerald-500/20">
            <div class="absolute top-0 right-0 w-64 h-64 bg-emerald-500/5 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>
            
            <div class="flex items-center gap-4 mb-8">
                <div class="w-12 h-12 bg-gradient-to-br from-yellow-500 to-amber-600 rounded-xl flex items-center justify-center shadow-lg text-white">
                    <i class="fas fa-lightbulb text-xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-white">Insights Estratégicos</h2>
                    <p class="text-sm text-gray-400">Recomendaciones generadas por IA basadas en datos reales</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="insights-container">
                <!-- Insight Default 1 -->
                <div class="bg-emerald-900/20 border-l-4 border-emerald-500 p-5 rounded-r-lg">
                    <div class="flex gap-4">
                        <i class="fas fa-sync fa-spin text-emerald-500 mt-1"></i>
                        <div>
                            <h3 class="font-bold text-emerald-400 mb-1">Analizando Datos...</h3>
                            <p class="text-sm text-gray-400">Conectando con el ledger distribuido para generar insights.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        let db, auth, user;
        let trendChart = null;
        let breakdownChart = null;

        // Init Firebase
        async function initFirebase() {
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        user = currentUser;
                        document.getElementById('user-id-display').textContent = user.uid.substring(0, 8) + '...';
                        loadReportData();
                    }
                });
            } catch (error) {
                console.error("Firebase Error:", error);
            }
        }

        async function loadReportData() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';
            
            try {
                // Fetch all lotes for the user
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'lotes'), orderBy('date', 'asc'));
                const querySnapshot = await getDocs(q);
                
                const lotes = [];
                querySnapshot.forEach((doc) => {
                    lotes.push(doc.data());
                });

                if (lotes.length === 0) {
                    renderEmptyState();
                } else {
                    processAndRenderData(lotes);
                }

            } catch (e) {
                console.error("Error fetching report data:", e);
                renderEmptyState();
            }
        }

        function processAndRenderData(lotes) {
            // 1. Calculate KPIs
            const total = lotes.length;
            const conformes = lotes.filter(l => (l.simResult || 'Pendiente') === 'Conforme').length;
            const rechazados = lotes.filter(l => (l.simResult || 'Pendiente') === 'Descarte').length;
            const hallazgos = lotes.filter(l => (l.simResult || 'Pendiente') === 'Hallazgo').length;
            
            const conformityRate = total > 0 ? ((conformes / total) * 100).toFixed(1) : 0;

            // Update DOM KPIs
            document.getElementById('kpi-conformidad').textContent = `${conformityRate}%`;
            document.getElementById('kpi-rechazados').textContent = rechazados;
            document.getElementById('kpi-hallazgos').textContent = hallazgos;
            document.getElementById('kpi-total').textContent = total;

            // 2. Prepare Chart Data
            // Breakdown Data
            const breakdownData = [conformes, hallazgos, rechazados];
            
            // Trend Data (Group by Date - simple approximation for demo)
            // Agrupar por fecha corta
            const dateGroups = {};
            lotes.forEach(l => {
                const date = l.date ? new Date(l.date).toLocaleDateString() : 'N/A';
                if(!dateGroups[date]) dateGroups[date] = { total: 0, conformes: 0 };
                dateGroups[date].total++;
                if ((l.simResult || 'Conforme') === 'Conforme') dateGroups[date].conformes++;
            });

            const labels = Object.keys(dateGroups);
            const trendPoints = labels.map(date => {
                const dayData = dateGroups[date];
                return ((dayData.conformes / dayData.total) * 100).toFixed(1);
            });

            renderCharts(breakdownData, labels, trendPoints);
            generateInsights(conformityRate, rechazados, hallazgos, total);
        }

        function renderEmptyState() {
            document.getElementById('kpi-conformidad').textContent = "0%";
            document.getElementById('kpi-rechazados').textContent = "0";
            document.getElementById('kpi-hallazgos').textContent = "0";
            document.getElementById('kpi-total').textContent = "0";
            
            // Render empty charts to maintain layout
            renderCharts([0,0,0], [], []);
            
            document.getElementById('insights-container').innerHTML = `
                <div class="bg-gray-800/50 p-6 rounded-lg border border-gray-700 text-center col-span-2">
                    <p class="text-gray-400">No hay datos suficientes para generar un reporte estratégico.</p>
                </div>
            `;
        }

        function renderCharts(breakdownData, trendLabels, trendPoints) {
            Chart.defaults.color = '#94a3b8';
            Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';

            // Trend Chart
            const ctxTrend = document.getElementById('trendChart').getContext('2d');
            if (trendChart) trendChart.destroy();

            trendChart = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: trendLabels.length ? trendLabels : ['Sin Datos'],
                    datasets: [{
                        label: 'Tasa de Conformidad (%)',
                        data: trendPoints.length ? trendPoints : [0],
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#10B981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });

            // Breakdown Chart
            const ctxBreakdown = document.getElementById('breakdownChart').getContext('2d');
            if (breakdownChart) breakdownChart.destroy();

            // If no data, show placeholder
            const hasData = breakdownData.some(v => v > 0);
            
            breakdownChart = new Chart(ctxBreakdown, {
                type: 'doughnut',
                data: {
                    labels: ['Conformes', 'Hallazgos', 'Rechazados'],
                    datasets: [{
                        data: hasData ? breakdownData : [1, 0, 0], // Placeholder green if empty
                        backgroundColor: hasData ? ['#10B981', '#F59E0B', '#EF4444'] : ['#334155', '#334155', '#334155'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { usePointStyle: true, boxWidth: 8 }
                        }
                    }
                }
            });
        }

        function generateInsights(rate, rejected, warnings, total) {
            const container = document.getElementById('insights-container');
            container.innerHTML = '';
            
            const rateNum = parseFloat(rate);

            // Insight 1: Conformidad
            let conformityInsight = { title: '', text: '', color: '', icon: '' };
            if (rateNum >= 90) {
                conformityInsight = { 
                    title: 'Excelencia Operativa', 
                    text: `La tasa de conformidad del ${rate}% indica un control de calidad robusto y eficiente.`,
                    color: 'emerald', icon: 'thumbs-up'
                };
            } else if (rateNum >= 75) {
                conformityInsight = { 
                    title: 'Estabilidad con Oportunidades', 
                    text: `Con un ${rate}% de aprobación, el proceso es estable pero se detectan desviaciones menores recurrentes.`,
                    color: 'yellow', icon: 'minus-circle'
                };
            } else {
                conformityInsight = { 
                    title: 'Atención Crítica Requerida', 
                    text: `La tasa del ${rate}% está por debajo del estándar óptimo. Se recomienda revisión urgente de proveedores.`,
                    color: 'red', icon: 'exclamation-triangle'
                };
            }
            renderInsightCard(container, conformityInsight);

            // Insight 2: Rechazos
            if (rejected > 0) {
                renderInsightCard(container, {
                    title: 'Pérdidas por Calidad',
                    text: `Se han descartado ${rejected} lotes (${((rejected/total)*100).toFixed(1)}% del total). Foco sugerido: control de temperatura en tránsito.`,
                    color: 'red', icon: 'trash-alt'
                });
            } else if (total > 0) {
                 renderInsightCard(container, {
                    title: 'Cero Desperdicio',
                    text: `No se han registrado rechazos totales en el periodo analizado. Eficiencia máxima.`,
                    color: 'emerald', icon: 'leaf'
                });
            }

            // Insight 3: Volumen
            if (total > 10) {
                renderInsightCard(container, {
                    title: 'Alta Actividad de Auditoría',
                    text: `El volumen de ${total} registros asegura una muestra estadísticamente significativa para la toma de decisiones.`,
                    color: 'blue', icon: 'chart-bar'
                });
            }
        }

        function renderInsightCard(container, data) {
            const div = document.createElement('div');
            
            // Map color names to classes safely
            const colors = {
                emerald: { border: 'border-emerald-500', bg: 'bg-emerald-900/20', text: 'text-emerald-400', iconBg: 'bg-emerald-500' },
                yellow: { border: 'border-yellow-500', bg: 'bg-yellow-900/20', text: 'text-yellow-400', iconBg: 'bg-yellow-500' },
                red: { border: 'border-red-500', bg: 'bg-red-900/20', text: 'text-red-400', iconBg: 'bg-red-500' },
                blue: { border: 'border-blue-500', bg: 'bg-blue-900/20', text: 'text-blue-400', iconBg: 'bg-blue-500' }
            };
            const theme = colors[data.color] || colors.emerald;

            div.className = `${theme.bg} border-l-4 ${theme.border} p-5 rounded-r-lg transition-transform hover:translate-x-1`;
            div.innerHTML = `
                <div class="flex gap-4 items-start">
                    <div class="${theme.iconBg} w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0 mt-1">
                        <i class="fas fa-${data.icon} text-white text-sm"></i>
                    </div>
                    <div>
                        <h3 class="font-bold ${theme.text} mb-1">${data.title}</h3>
                        <p class="text-sm text-gray-300 leading-relaxed">${data.text}</p>
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        initFirebase();
    </script>
</body>
</html>