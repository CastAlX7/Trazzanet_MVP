<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Empaque - TrazaNet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .input-group {
            position: relative;
            margin-bottom: 1rem;
        }

        .input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            pointer-events: none;
        }

        .input-with-icon {
            padding-left: 2.5rem;
        }

        .submit-btn {
            position: relative;
            overflow: hidden;
        }

        .submit-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .submit-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .alert-box {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .alert-success {
            background-color: #d1fae5;
            border-left: 4px solid #10b981;
            color: #065f46;
        }

        .alert-error {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #991b1b;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .lote-row {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-left: 4px solid #3b82f6;
            transition: all 0.3s ease;
        }

        .lote-row:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .delete-btn {
            transition: all 0.2s ease;
        }

        .delete-btn:hover {
            transform: scale(1.1);
        }

        .add-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .section-header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .qc-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
        }
    </style>
</head>

<body>
    <div class="glass-panel p-8 rounded-xl shadow-2xl w-full max-w-6xl mx-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-3xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-box mr-3 text-blue-600"></i> Registro de Empaque
            </h2>
            <span class="text-sm text-gray-500">
                <i class="fas fa-layer-group mr-1"></i> Creación de Lotes Comerciales
            </span>
        </div>

        <form id="empaque-form">
            <!-- Información del Lote de Origen -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- ID del Lote de Origen (Read-only) -->
                <div>
                    <label for="lote-id-origen" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-barcode mr-1 text-blue-500"></i> ID del Lote de Origen
                    </label>
                    <div class="input-group">
                        <i class="fas fa-qrcode input-icon"></i>
                        <input type="text" id="lote-id-origen" name="lote-id-origen" required readonly
                            placeholder="LOTE-ORIGEN-001"
                            class="input-with-icon mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm p-2 border cursor-not-allowed">
                    </div>
                </div>

                <!-- Fecha de Empaque -->
                <div>
                    <label for="fecha-empaque" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-calendar-alt mr-1 text-blue-500"></i> Fecha de Empaque
                    </label>
                    <div class="input-group">
                        <i class="fas fa-clock input-icon"></i>
                        <input type="date" id="fecha-empaque" name="fecha-empaque" required
                            class="input-with-icon mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    </div>
                </div>
            </div>

            <!-- Sección de Lotes Comerciales -->
            <div class="section-header">
                <h3 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-boxes mr-2"></i> Lotes Comerciales de Exportación
                </h3>
                <p class="text-sm opacity-90 mt-1">Subdivida el lote de origen en múltiples lotes comerciales</p>
            </div>

            <div id="lotes-container" class="space-y-4 mb-6">
                <!-- Los lotes comerciales se añadirán dinámicamente aquí -->
            </div>

            <button type="button" id="add-lote-btn"
                class="add-btn w-full py-3 px-4 rounded-md shadow-sm text-sm font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 mb-6">
                <i class="fas fa-plus-circle mr-2"></i> Añadir Nuevo Lote Comercial
            </button>

            <!-- Control de Calidad Final -->
            <div class="section-header">
                <h3 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-clipboard-check mr-2"></i> Control de Calidad Final (QC)
                </h3>
                <p class="text-sm opacity-90 mt-1">Parámetros críticos para validación del Smart Contract</p>
            </div>

            <div class="qc-section p-6 rounded-lg mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Materia Seca -->
                    <div>
                        <label for="materia-seca" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-flask mr-1 text-amber-600"></i> Materia Seca (%)
                            <span class="text-xs text-red-600 font-semibold">(Parámetro Crítico)</span>
                        </label>
                        <div class="input-group">
                            <i class="fas fa-percentage input-icon"></i>
                            <input type="number" id="materia-seca" name="materia-seca" step="0.1" min="0" max="100"
                                required placeholder="0.0"
                                class="input-with-icon mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-amber-500 focus:ring-amber-500 p-2 border">
                        </div>
                        <p class="text-xs text-gray-600 mt-1">
                            <i class="fas fa-info-circle"></i> Umbral mínimo: 20%
                        </p>
                    </div>

                    <!-- Observaciones de Descarte -->
                    <div>
                        <label for="observaciones-descarte" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-comment-alt mr-1 text-amber-600"></i> Observaciones de Descarte
                        </label>
                        <textarea id="observaciones-descarte" name="observaciones-descarte" rows="3"
                            placeholder="Registre cualquier rechazo parcial o anomalía detectada..."
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-amber-500 focus:ring-amber-500 p-2 border"></textarea>
                    </div>
                </div>
            </div>

            <!-- Alert Box -->
            <div id="alert-box" class="alert-box"></div>

            <!-- Submit Button -->
            <button type="submit"
                class="submit-btn w-full mt-6 py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                <i class="fas fa-paper-plane mr-2"></i>
                <span id="btn-text">Registrar Empaque y Ejecutar Smart Contract</span>
                <span id="btn-spinner" class="loading-spinner ml-2" style="display: none;"></span>
            </button>

            <!-- Info Box -->
            <div class="mt-4 p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-blue-400"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-blue-700">
                            <strong>Acción del Sistema:</strong> Al enviar, se registrará una transacción de tipo
                            <code class="bg-blue-100 px-1 rounded">BatchTransformation</code> en la blockchain y se
                            ejecutará el <strong>Smart Contract de Calidad Final</strong> para validar que
                            <strong>MATERIA_SECA_PORCENTAJE ≥ 20%</strong>.
                        </p>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script>
        let loteCounter = 0;

        // Set current date as default
        document.addEventListener('DOMContentLoaded', function () {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fecha-empaque').value = today;

            // Simulate loading lote origen from URL params or previous step
            const urlParams = new URLSearchParams(window.location.search);
            const loteOrigen = urlParams.get('lote') || 'LOTE-CAMPO-' + Math.floor(Math.random() * 1000).toString().padStart(4, '0');
            document.getElementById('lote-id-origen').value = loteOrigen;

            // Add first commercial lot by default
            addLoteComercial();
        });

        // Add new commercial lot row
        document.getElementById('add-lote-btn').addEventListener('click', function () {
            addLoteComercial();
        });

        function addLoteComercial() {
            loteCounter++;
            const container = document.getElementById('lotes-container');

            const loteRow = document.createElement('div');
            loteRow.className = 'lote-row p-4 rounded-lg';
            loteRow.id = `lote-${loteCounter}`;

            loteRow.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-lg font-semibold text-gray-700">
                        <i class="fas fa-box-open mr-2 text-blue-500"></i> Lote Comercial #${loteCounter}
                    </h4>
                    <button type="button" class="delete-btn text-red-500 hover:text-red-700" onclick="removeLote(${loteCounter})">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- ID Comercial Único -->
                    <div>
                        <label for="lote-comercial-id-${loteCounter}" class="block text-xs font-medium text-gray-700 mb-1">
                            <i class="fas fa-tag mr-1"></i> ID Comercial
                        </label>
                        <input type="text" id="lote-comercial-id-${loteCounter}" name="lote-comercial-id[]" required
                            placeholder="EXP-${loteCounter.toString().padStart(4, '0')}"
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                    </div>

                    <!-- Calibre -->
                    <div>
                        <label for="calibre-${loteCounter}" class="block text-xs font-medium text-gray-700 mb-1">
                            <i class="fas fa-ruler mr-1"></i> Calibre
                        </label>
                        <select id="calibre-${loteCounter}" name="calibre[]" required
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                            <option value="">Seleccionar...</option>
                            <option value="10">10</option>
                            <option value="12">12</option>
                            <option value="14">14</option>
                            <option value="16">16</option>
                            <option value="18">18</option>
                            <option value="20">20</option>
                        </select>
                    </div>

                    <!-- Peso por Caja -->
                    <div>
                        <label for="peso-caja-${loteCounter}" class="block text-xs font-medium text-gray-700 mb-1">
                            <i class="fas fa-weight-hanging mr-1"></i> Peso/Caja (KG)
                        </label>
                        <input type="number" id="peso-caja-${loteCounter}" name="peso-caja[]" step="0.01" min="0" required
                            placeholder="0.00"
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                    </div>

                    <!-- Cantidad de Cajas -->
                    <div>
                        <label for="num-cajas-${loteCounter}" class="block text-xs font-medium text-gray-700 mb-1">
                            <i class="fas fa-boxes mr-1"></i> Nº de Cajas
                        </label>
                        <input type="number" id="num-cajas-${loteCounter}" name="num-cajas[]" min="1" required
                            placeholder="0"
                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                    </div>
                </div>
            `;

            container.appendChild(loteRow);

            // Auto-generate commercial ID
            const comercialIdInput = document.getElementById(`lote-comercial-id-${loteCounter}`);
            comercialIdInput.value = `EXP-${Date.now().toString().slice(-6)}-${loteCounter.toString().padStart(2, '0')}`;
        }

        function removeLote(id) {
            const loteRow = document.getElementById(`lote-${id}`);
            if (loteRow) {
                loteRow.style.opacity = '0';
                loteRow.style.transform = 'translateX(-20px)';
                setTimeout(() => {
                    loteRow.remove();
                    // Ensure at least one lot remains
                    if (document.getElementById('lotes-container').children.length === 0) {
                        addLoteComercial();
                    }
                }, 300);
            }
        }

        // Form submission handler
        document.getElementById('empaque-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const btnText = document.getElementById('btn-text');
            const btnSpinner = document.getElementById('btn-spinner');
            const alertBox = document.getElementById('alert-box');
            const submitBtn = e.target.querySelector('button[type="submit"]');

            // Validate materia seca threshold
            const materiaSeca = parseFloat(document.getElementById('materia-seca').value);
            if (materiaSeca < 20) {
                alertBox.className = 'alert-box alert-error';
                alertBox.innerHTML = `
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>Error de Validación:</strong> La materia seca debe ser ≥ 20%. 
                    Valor actual: ${materiaSeca}%. El lote no cumple con los estándares de calidad.
                `;
                alertBox.style.display = 'block';
                return;
            }

            // Disable button and show loading state
            submitBtn.disabled = true;
            btnText.textContent = 'Procesando...';
            btnSpinner.style.display = 'inline-block';

            // Collect commercial lots data
            const lotesComerciales = [];
            const comercialIds = document.getElementsByName('lote-comercial-id[]');
            const calibres = document.getElementsByName('calibre[]');
            const pesosCaja = document.getElementsByName('peso-caja[]');
            const numCajas = document.getElementsByName('num-cajas[]');

            for (let i = 0; i < comercialIds.length; i++) {
                lotesComerciales.push({
                    idComercial: comercialIds[i].value,
                    calibre: calibres[i].value,
                    pesoCajaKg: parseFloat(pesosCaja[i].value),
                    numeroCajas: parseInt(numCajas[i].value),
                    pesoTotalKg: parseFloat(pesosCaja[i].value) * parseInt(numCajas[i].value)
                });
            }

            // Collect form data
            const formData = {
                loteIdOrigen: document.getElementById('lote-id-origen').value,
                fechaEmpaque: document.getElementById('fecha-empaque').value,
                lotesComerciales: lotesComerciales,
                controlCalidad: {
                    materiaSecaPorcentaje: materiaSeca,
                    observacionesDescarte: document.getElementById('observaciones-descarte').value
                },
                tipoEvento: 'BatchTransformation',
                fase: 'Empaque',
                timestamp: new Date().toISOString()
            };

            try {
                // TODO: Replace with actual API endpoint
                // const response = await fetch('http://localhost:3000/api/register-empaque', {
                //     method: 'POST',
                //     headers: {
                //         'Content-Type': 'application/json',
                //     },
                //     body: JSON.stringify(formData)
                // });

                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Calculate totals
                const totalCajas = lotesComerciales.reduce((sum, lote) => sum + lote.numeroCajas, 0);
                const totalPeso = lotesComerciales.reduce((sum, lote) => sum + lote.pesoTotalKg, 0);

                // Show success message
                alertBox.className = 'alert-box alert-success';
                alertBox.innerHTML = `
                    <div class="flex items-start">
                        <i class="fas fa-check-circle text-green-600 mr-3 mt-1"></i>
                        <div>
                            <strong>Empaque Registrado Exitosamente</strong>
                            <ul class="mt-2 text-sm list-disc list-inside">
                                <li>Lote de origen: <strong>${formData.loteIdOrigen}</strong></li>
                                <li>Lotes comerciales creados: <strong>${lotesComerciales.length}</strong></li>
                                <li>Total de cajas: <strong>${totalCajas}</strong></li>
                                <li>Peso total: <strong>${totalPeso.toFixed(2)} KG</strong></li>
                                <li>Materia seca: <strong>${materiaSeca}%</strong> 
                                    <span class="text-green-700">✓ Aprobado</span>
                                </li>
                                <li>Smart Contract ejecutado: <span class="text-green-700">✓ Validación exitosa</span></li>
                                <li>Transacción blockchain: <strong>#${Math.random().toString(36).substr(2, 9).toUpperCase()}</strong></li>
                            </ul>
                        </div>
                    </div>
                `;
                alertBox.style.display = 'block';

                // Reset form after 4 seconds
                setTimeout(() => {
                    if (confirm('¿Desea registrar otro empaque?')) {
                        location.reload();
                    }
                }, 4000);

            } catch (error) {
                console.error('Error al registrar empaque:', error);
                alertBox.className = 'alert-box alert-error';
                alertBox.innerHTML = `
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <strong>Error:</strong> No se pudo registrar el empaque. Por favor, intente nuevamente.
                `;
                alertBox.style.display = 'block';
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                btnText.textContent = 'Registrar Empaque y Ejecutar Smart Contract';
                btnSpinner.style.display = 'none';
            }
        });
    </script>
</body>

</html>