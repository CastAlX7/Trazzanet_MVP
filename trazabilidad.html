<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trazabilidad de Aguacates - TrazaNet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 2rem;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            margin: 1rem 0;
        }

        .flow-item {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-weight: 600;
            color: #4f46e5;
        }

        .flow-arrow {
            color: #6366f1;
            font-size: 1.5rem;
        }
    </style>
</head>

<body class="bg-gray-50">
    <div class="flex min-h-screen">
        <aside class="w-64 bg-white border-r border-gray-200 p-4 flex flex-col shadow-lg">
            <h1 class="text-2xl font-bold text-indigo-600 mb-8">TrazaNet</h1>
            <nav class="space-y-2">
                <a href="dashboard.html"
                    class="flex items-center p-3 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition duration-150">
                    <i class="fas fa-tachometer-alt w-5 h-5 mr-3"></i>
                    Dashboard
                </a>
                <a href="carga.html"
                    class="flex items-center p-3 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition duration-150">
                    <i class="fas fa-upload w-5 h-5 mr-3"></i>
                    Carga de Datos
                </a>
                <a href="trazabilidad.html"
                    class="flex items-center p-3 bg-indigo-50 text-indigo-600 font-semibold rounded-lg transition duration-150">
                    <i class="fas fa-project-diagram w-5 h-5 mr-3"></i>
                    Trazabilidad
                </a>
                <a href="auditoria.html"
                    class="flex items-center p-3 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition duration-150">
                    <i class="fas fa-clipboard-check w-5 h-5 mr-3"></i>
                    Auditoría
                </a>
                <a href="gestor_certificaciones.html"
                    class="flex items-center p-3 text-gray-600 hover:bg-indigo-50 hover:text-indigo-600 rounded-lg transition duration-150">
                    <i class="fas fa-certificate w-5 h-5 mr-3"></i>
                    Certificaciones
                </a>
            </nav>
            <div class="mt-auto pt-4 border-t border-gray-200">
                <p class="text-xs text-gray-500 truncate" id="user-id-display">ID Usuario: Cargando...</p>
            </div>
        </aside>
        <main class="flex-1 p-8">
            <div class="mb-6">
                <h2 class="text-3xl font-bold text-gray-800">Trazabilidad de Aguacates</h2>
                <p class="text-gray-600 mt-2">Explora el historial inmutable de cada lote y producto, desde el origen
                    hasta el destino final, respaldado por la tecnología Blockchain.</p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500 card">
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-gray-500">Lotes Activos</p>
                        <i class="fas fa-boxes text-blue-500 text-2xl"></i>
                    </div>
                    <p class="text-4xl font-bold text-gray-900 mt-2" id="lotes-activos">125</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500 card">
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-gray-500">Productos Rastreados</p>
                        <i class="fas fa-leaf text-green-500 text-2xl"></i>
                    </div>
                    <p class="text-4xl font-bold text-gray-900 mt-2" id="productos-rastreados">7.8K</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-cyan-500 card">
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-gray-500">Transacciones Blockchain</p>
                        <i class="fas fa-link text-cyan-500 text-2xl"></i>
                    </div>
                    <p class="text-4xl font-bold text-gray-900 mt-2" id="transacciones-blockchain">3.2M</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500 card">
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-gray-500">Alertas Críticas</p>
                        <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                    </div>
                    <p class="text-4xl font-bold text-gray-900 mt-2 text-red-600" id="alertas-criticas">3</p>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Detalle de Proceso</h3>
                <h4 class="text-lg font-medium text-gray-700 mb-3">Transformación de Lote</h4>
                <div class="flow-diagram">
                    <div class="flow-item">ID Lote: AVO-20231025-001</div>
                    <i class="fas fa-arrow-down flow-arrow"></i>
                    <div class="flex flex-wrap gap-3 justify-center">
                        <div class="flow-item text-sm">ID Producto: AVO-20231025-001-A</div>
                        <div class="flow-item text-sm">ID Producto: AVO-20231025-001-B</div>
                        <div class="flow-item text-sm">ID Producto: AVO-20231025-001-C</div>
                        <div class="flow-item text-sm">ID Producto: AVO-20231025-001-D</div>
                        <div class="flow-item text-sm">ID Producto: AVO-20231025-001-E</div>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="search-input" placeholder="Buscar por ID de Lote o Producto..."
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <button onclick="filterByDate()"
                        class="flex items-center justify-center px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-150">
                        <i class="fas fa-calendar-alt mr-2 text-gray-600"></i>
                        Filtrar por Fecha
                    </button>
                    <button onclick="filterByLocation()"
                        class="flex items-center justify-center px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-150">
                        <i class="fas fa-map-marker-alt mr-2 text-gray-600"></i>
                        Filtrar por Ubicación
                    </button>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-history text-indigo-600 mr-2"></i>
                        Historial Completo de Trazabilidad
                    </h3>
                    <div class="flex items-center text-sm text-gray-600">
                        <i class="fas fa-database mr-2 text-indigo-600"></i>
                        Datos sincronizados en Blockchain
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha/Hora
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID Lote</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID Producto
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Evento</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descripción
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ubicación
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado TX
                                    Blockchain</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Blockchain
                                    TX ID</th>
                            </tr>
                        </thead>
                        <tbody id="traceability-table-body" class="divide-y divide-gray-200">
                            <tr class="hover:bg-gray-50 transition duration-150">
                                <td class="px-6 py-4 text-sm text-gray-600">2023-10-25 08:00</td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-700">AVO-20231025-001</td>
                                <td class="px-6 py-4 text-sm text-gray-600">N/A</td>
                                <td class="px-6 py-4 text-sm text-gray-900">Cosecha</td>
                                <td class="px-6 py-4 text-sm text-gray-600">Recolección manual de aguacates</td>
                                <td class="px-6 py-4 text-sm text-gray-600">Finca El Paraíso, México</td>
                                <td class="px-6 py-4">
                                    <span class="status-badge bg-green-100 text-green-700">
                                        <i class="fas fa-check-circle mr-1"></i>Confirmado
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-500">0xab12356...</td>
                            </tr>
                            <tr class="hover:bg-gray-50 transition duration-150">
                                <td class="px-6 py-4 text-sm text-gray-600">2023-10-25 14:30</td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-700">AVO-20231025-001</td>
                                <td class="px-6 py-4 text-sm text-gray-600">N/A</td>
                                <td class="px-6 py-4 text-sm text-gray-900">Recepción</td>
                                <td class="px-6 py-4 text-sm text-gray-600">Lote recibido en centro de procesamiento
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600">Centro Procesador Guadalajara</td>
                                <td class="px-6 py-4">
                                    <span class="status-badge bg-green-100 text-green-700">
                                        <i class="fas fa-check-circle mr-1"></i>Confirmado
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-500">0x1235a445...</td>
                            </tr>
                            <tr class="hover:bg-gray-50 transition duration-150">
                                <td class="px-6 py-4 text-sm text-gray-600">2023-10-25 09:15</td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-700">AVO-20231025-001</td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-700">AVO-20231025-001-A</td>
                                <td class="px-6 py-4 text-sm text-gray-900">Clasificación</td>
                                <td class="px-6 py-4 text-sm text-gray-600">Clasificación por tamaño y calidad</td>
                                <td class="px-6 py-4 text-sm text-gray-600">Líneas de Procesamiento 1</td>
                                <td class="px-6 py-4">
                                    <span class="status-badge bg-green-100 text-green-700">
                                        <i class="fas fa-check-circle mr-1"></i>Confirmado
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-500">0xdef45678...</td>
                            </tr>
                            <tr class="hover:bg-gray-50 transition duration-150">
                                <td class="px-6 py-4 text-sm text-gray-600">2023-10-26 11:00</td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-700">AVO-20231025-001</td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-700">AVO-20231025-001-A</td>
                                <td class="px-6 py-4 text-sm text-gray-900">Empaquetado</td>
                                <td class="px-6 py-4 text-sm text-gray-600">Empaquetado en cajas de 10 kg</td>
                                <td class="px-6 py-4 text-sm text-gray-600">Área de Empaque Zona A</td>
                                <td class="px-6 py-4">
                                    <span class="status-badge bg-green-100 text-green-700">
                                        <i class="fas fa-check-circle mr-1"></i>Confirmado
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-500">0xc4567890...</td>
                            </tr>
                            <tr class="hover:bg-gray-50 transition duration-150">
                                <td class="px-6 py-4 text-sm text-gray-600">2023-10-27 07:00</td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-700">AVO-20231025-001</td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-700">AVO-20231025-001-A</td>
                                <td class="px-6 py-4 text-sm text-gray-900">Envío</td>
                                <td class="px-6 py-4 text-sm text-gray-600">Cargado en contenedor refrigerado</td>
                                <td class="px-6 py-4 text-sm text-gray-600">Muelle de Carga 3</td>
                                <td class="px-6 py-4">
                                    <span class="status-badge bg-yellow-100 text-yellow-700">
                                        <i class="fas fa-clock mr-1"></i>Pendiente
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-500">0x7090abcd...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="mt-6 text-center text-sm text-gray-500">
                <p>© 2025 TrazaNet. Todos los derechos reservados.</p>
            </div>
        </main>
    </div>
    <script>
        // API Configuration
        const API_BASE_URL = '/api';

        // User ID Management
        function getOrCreateUserId() {
            let storedUserId = sessionStorage.getItem('trazanet_user_id');
            if (!storedUserId) {
                storedUserId = 'user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('trazanet_user_id', storedUserId);
            }
            return storedUserId;
        }

        // Fetch Dashboard Stats
        async function loadDashboardStats() {
            try {
                const userId = getOrCreateUserId();
                const response = await fetch(`${API_BASE_URL}/dashboard/stats?userId=${userId}`);
                const data = await response.json();

                if (data.success) {
                    const stats = data.data;

                    // Animate numbers
                    animateValue("lotes-activos", 0, stats.lotesActivos, 1000);
                    animateValue("transacciones-blockchain", 0, stats.transaccionesConfirmadas, 1500);
                    animateValue("alertas-criticas", 0, stats.alertasCriticas, 500);

                    // Calculate real products from uploaded files
                    await calculateRealProducts(userId);
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        // Calculate real products from uploaded files
        async function calculateRealProducts(userId) {
            try {
                const historyResponse = await fetch(`${API_BASE_URL}/history?userId=${userId}`);
                const historyData = await historyResponse.json();

                if (!historyData.success || !historyData.data) {
                    animateValue("productos-rastreados", 0, 0, 1000);
                    return;
                }

                let totalProducts = 0;

                // Fetch and count products from each batch
                for (const batch of historyData.data) {
                    if (batch.calidadFruta && batch.calidadFruta.total) {
                        totalProducts += batch.calidadFruta.total;
                    }
                }

                animateValue("productos-rastreados", 0, totalProducts, 2000, totalProducts > 1000);
            } catch (error) {
                console.error('Error calculating real products:', error);
                animateValue("productos-rastreados", 0, 0, 1000);
            }
        }

        // Helper to animate numbers
        function animateValue(id, start, end, duration, isK = false) {
            const obj = document.getElementById(id);
            if (!obj) return;

            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);

                let value = Math.floor(progress * (end - start) + start);

                if (isK && value > 1000) {
                    obj.innerHTML = (value / 1000).toFixed(1) + 'K';
                } else {
                    obj.innerHTML = value;
                }

                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        // Fetch Traceability Data
        async function loadTraceabilityData() {
            try {
                const userId = getOrCreateUserId();
                const response = await fetch(`${API_BASE_URL}/traceability?userId=${userId}`);
                const data = await response.json();

                if (data.success) {
                    renderTraceabilityTable(data.data);
                    updateFlowDiagram(data.data);
                }
            } catch (error) {
                console.error('Error loading traceability data:', error);
                document.getElementById('traceability-table-body').innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-4 text-center text-red-500">
                            Error al cargar datos. Asegúrate de que el servidor esté corriendo.
                        </td>
                    </tr>
                `;
            }
        }

        // Render Table
        function renderTraceabilityTable(events) {
            const tbody = document.getElementById('traceability-table-body');
            tbody.innerHTML = '';

            if (events.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                            No hay registros de trazabilidad disponibles.
                        </td>
                    </tr>
                `;
                return;
            }

            events.forEach(event => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition duration-150';

                // Format date
                const date = new Date(event.fecha);
                const formattedDate = date.toLocaleString('es-ES', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                });

                // Determine status badge color
                let statusClass = 'bg-green-100 text-green-700';
                let iconClass = 'fa-check-circle';

                if (event.estadoTx === 'Pendiente') {
                    statusClass = 'bg-yellow-100 text-yellow-700';
                    iconClass = 'fa-clock';
                } else if (event.estadoTx === 'Fallido') {
                    statusClass = 'bg-red-100 text-red-700';
                    iconClass = 'fa-times-circle';
                }

                tr.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-600">${formattedDate}</td>
                    <td class="px-6 py-4 text-sm font-mono text-gray-700">${event.loteId}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${event.productoId}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 font-medium">${event.evento}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${event.descripcion}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${event.ubicacion}</td>
                    <td class="px-6 py-4">
                        <span class="status-badge ${statusClass}">
                            <i class="fas ${iconClass} mr-1"></i>${event.estadoTx}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm font-mono text-gray-500" title="${event.blockchainTxId}">
                        ${event.blockchainTxId.substring(0, 10)}...
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Update Flow Diagram with latest lot info
        function updateFlowDiagram(events) {
            if (!events || events.length === 0) return;

            // Find the most recent lot ID
            const latestEvent = events[0];
            const loteId = latestEvent.loteId;

            // Update the diagram text
            const flowLoteId = document.querySelector('.flow-diagram .flow-item:first-child');
            if (flowLoteId) {
                flowLoteId.textContent = `ID Lote: ${loteId}`;
            }

            // Update product IDs (simulated derivation)
            const productItems = document.querySelectorAll('.flow-diagram .flow-item.text-sm');
            productItems.forEach((item, index) => {
                const suffix = String.fromCharCode(65 + index); // A, B, C...
                item.textContent = `ID Producto: ${loteId}-${suffix}`;
            });
        }

        // Filter Functions
        function filterByDate() {
            const date = prompt("Ingrese la fecha a filtrar (YYYY-MM-DD):");
            if (!date) return;

            const rows = document.querySelectorAll('#traceability-table-body tr');
            rows.forEach(row => {
                const dateCell = row.cells[0].textContent;
                // Simple string match for the date part
                if (dateCell.includes(date)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function filterByLocation() {
            const location = prompt("Ingrese la ubicación a buscar:");
            if (!location) return;

            const searchTerm = location.toLowerCase();
            const rows = document.querySelectorAll('#traceability-table-body tr');
            rows.forEach(row => {
                const locationCell = row.cells[5].textContent.toLowerCase();
                if (locationCell.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Search Functionality
        document.getElementById('search-input')?.addEventListener('input', function (e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#traceability-table-body tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            const userId = getOrCreateUserId();
            document.getElementById('user-id-display').textContent = `ID Usuario: ${userId}`;

            loadDashboardStats();
            loadTraceabilityData();
        });
    </script>
</body>

</html>