<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transferencia de Activo Digital - TrazaNet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .input-group {
            position: relative;
            margin-bottom: 1rem;
        }

        .input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            pointer-events: none;
            z-index: 10;
        }

        .input-with-icon {
            padding-left: 2.5rem;
        }

        .submit-btn {
            position: relative;
            overflow: hidden;
        }

        .submit-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .submit-btn:hover::before {
            width: 400px;
            height: 400px;
        }

        .alert-box {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .alert-success {
            background-color: #d1fae5;
            border-left: 4px solid #10b981;
            color: #065f46;
        }

        .alert-error {
            background-color: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #991b1b;
        }

        .alert-warning {
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .wallet-display {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-left: 4px solid #8b5cf6;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            color: #1e293b;
            word-break: break-all;
        }

        .security-badge {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
            padding: 0.75rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .transaction-summary {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }

        .crypto-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #6b7280;
            z-index: 10;
            transition: color 0.2s;
        }

        .password-toggle:hover {
            color: #4b5563;
        }

        .fee-info {
            background: #f9fafb;
            border: 1px dashed #d1d5db;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>

<body>
    <div class="glass-panel p-8 rounded-xl shadow-2xl w-full max-w-2xl">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-3xl font-bold text-gray-800 flex items-center">
                <div class="crypto-icon mr-3">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                Transferencia de Activo Digital
            </h2>
            <span class="text-sm text-gray-500 flex items-center">
                <i class="fas fa-shield-alt mr-1 text-green-600"></i>
                Blockchain Seguro
            </span>
        </div>

        <!-- Security Notice -->
        <div class="security-badge mb-6">
            <i class="fas fa-info-circle text-amber-600 text-xl"></i>
            <div>
                <p class="text-sm font-semibold text-amber-900">Transacción Criptográfica</p>
                <p class="text-xs text-amber-700">Esta operación requiere autenticación digital y es irreversible</p>
            </div>
        </div>

        <form id="transaction-form">
            <!-- Asset ID -->
            <div class="mb-6">
                <label for="asset-id" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-cube mr-1 text-purple-600"></i> ID del Activo a Transferir
                    <span class="text-red-600">*</span>
                </label>
                <div class="input-group">
                    <i class="fas fa-barcode input-icon"></i>
                    <input type="text" id="asset-id" name="asset-id" required placeholder="LOTE-COMERCIAL-001"
                        class="input-with-icon mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-3 border">
                </div>
                <p class="text-xs text-gray-500 mt-1">
                    <i class="fas fa-lightbulb"></i> Ingrese el ID del lote comercial (NFT) que desea vender
                </p>
            </div>

            <!-- Wallet Origin (Read-only) -->
            <div class="mb-6">
                <label for="wallet-origin" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-wallet mr-1 text-purple-600"></i> Wallet Origen (Vendedor)
                </label>
                <div class="wallet-display">
                    <div class="flex items-center justify-between">
                        <span id="wallet-origin">0x0000000000000000000000000000000000000000</span>
                        <button type="button" onclick="copyToClipboard('wallet-origin')"
                            class="text-purple-600 hover:text-purple-800 ml-2">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-1">
                    <i class="fas fa-user-shield"></i> Su dirección de wallet (generada automáticamente)
                </p>
            </div>

            <!-- Wallet Destination -->
            <div class="mb-6">
                <label for="wallet-destination" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-paper-plane mr-1 text-purple-600"></i> Wallet Destino (Comprador)
                    <span class="text-red-600">*</span>
                </label>
                <div class="input-group">
                    <i class="fas fa-address-card input-icon"></i>
                    <input type="text" id="wallet-destination" name="wallet-destination" required
                        placeholder="0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
                        class="input-with-icon mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 p-3 border font-mono text-sm">
                </div>
                <p class="text-xs text-gray-500 mt-1">
                    <i class="fas fa-exclamation-triangle text-amber-500"></i> Verifique cuidadosamente la dirección del
                    comprador
                </p>
            </div>

            <!-- Transaction Amount -->
            <div class="mb-6">
                <label for="transaction-amount" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-dollar-sign mr-1 text-green-600"></i> Monto de la Transacción (USD)
                    <span class="text-red-600">*</span>
                </label>
                <div class="input-group">
                    <i class="fas fa-money-bill-wave input-icon"></i>
                    <input type="number" id="transaction-amount" name="transaction-amount" step="0.01" min="0.01"
                        required placeholder="0.00"
                        class="input-with-icon mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-3 border text-lg font-semibold">
                </div>
                <div class="fee-info mt-2">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Tarifa de Gas (estimada):</span>
                        <span class="font-semibold text-gray-800">$<span id="gas-fee">0.50</span></span>
                    </div>
                    <div class="flex justify-between items-center mt-1 pt-1 border-t border-gray-300">
                        <span class="text-gray-800 font-medium">Total a Recibir:</span>
                        <span class="font-bold text-green-600 text-lg">$<span id="total-receive">0.00</span></span>
                    </div>
                </div>
            </div>

            <!-- Digital Signature / PIN -->
            <div class="mb-6">
                <label for="digital-pin" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-key mr-1 text-red-600"></i> Firma Digital / PIN de Autorización
                    <span class="text-red-600">*</span>
                </label>
                <div class="input-group">
                    <i class="fas fa-lock input-icon"></i>
                    <input type="password" id="digital-pin" name="digital-pin" required
                        placeholder="Ingrese su PIN o clave privada"
                        class="input-with-icon mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-3 border">
                    <i class="fas fa-eye password-toggle" id="toggle-password" onclick="togglePasswordVisibility()"></i>
                </div>
                <p class="text-xs text-red-600 mt-1">
                    <i class="fas fa-shield-alt"></i> Requerido para autenticación criptográfica
                </p>
            </div>

            <!-- Transaction Summary -->
            <div class="transaction-summary" id="transaction-summary" style="display: none;">
                <h4 class="font-semibold text-blue-900 mb-2 flex items-center">
                    <i class="fas fa-clipboard-list mr-2"></i> Resumen de Transacción
                </h4>
                <div class="space-y-1 text-sm text-blue-800">
                    <div class="flex justify-between">
                        <span>Activo:</span>
                        <span class="font-mono font-semibold" id="summary-asset">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span>De:</span>
                        <span class="font-mono text-xs" id="summary-from">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Para:</span>
                        <span class="font-mono text-xs" id="summary-to">-</span>
                    </div>
                    <div class="flex justify-between font-bold text-base pt-2 border-t border-blue-300">
                        <span>Monto:</span>
                        <span class="text-green-700" id="summary-amount">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Alert Box -->
            <div id="alert-box" class="alert-box"></div>

            <!-- Submit Button -->
            <button type="submit"
                class="submit-btn w-full mt-6 py-4 px-4 border border-transparent rounded-md shadow-sm text-base font-semibold text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150">
                <i class="fas fa-rocket mr-2"></i>
                <span id="btn-text">Ejecutar Transferencia Blockchain</span>
                <span id="btn-spinner" class="loading-spinner ml-2" style="display: none;"></span>
            </button>

            <!-- Info Box -->
            <div class="mt-4 p-4 bg-purple-50 border-l-4 border-purple-400 rounded">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-purple-400 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-purple-700">
                            <strong>Acción del Sistema:</strong> Al confirmar, se ejecutará un
                            <code class="bg-purple-100 px-1 rounded">AssetTransfer</code> en la blockchain,
                            transfiriendo la propiedad del lote al comprador y activando el
                            <strong>Smart Contract de Escrow</strong> para procesar el pago de
                            <strong id="info-amount">$0.00 USD</strong>.
                        </p>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script>
        // Initialize wallet address
        function getOrCreateWalletId() {
            let walletId = sessionStorage.getItem('trazanet_wallet_id');
            if (!walletId) {
                // Generate a simulated Ethereum-style address
                walletId = '0x' + Array.from({ length: 40 }, () =>
                    Math.floor(Math.random() * 16).toString(16)
                ).join('');
                sessionStorage.setItem('trazanet_wallet_id', walletId);
            }
            return walletId;
        }

        // Copy to clipboard function
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                // Show temporary feedback
                const originalText = element.innerHTML;
                element.innerHTML = '<span class="text-green-600">✓ Copiado</span>';
                setTimeout(() => {
                    element.textContent = text;
                }, 2000);
            });
        }

        // Toggle password visibility
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('digital-pin');
            const toggleIcon = document.getElementById('toggle-password');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        // Update transaction summary
        function updateSummary() {
            const assetId = document.getElementById('asset-id').value;
            const walletOrigin = document.getElementById('wallet-origin').textContent;
            const walletDestination = document.getElementById('wallet-destination').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value) || 0;

            if (assetId && walletDestination && amount > 0) {
                document.getElementById('summary-asset').textContent = assetId;
                document.getElementById('summary-from').textContent = walletOrigin.substring(0, 20) + '...';
                document.getElementById('summary-to').textContent = walletDestination.substring(0, 20) + '...';
                document.getElementById('summary-amount').textContent = `$${amount.toFixed(2)}`;
                document.getElementById('transaction-summary').style.display = 'block';
            } else {
                document.getElementById('transaction-summary').style.display = 'none';
            }
        }

        // Calculate fees and total
        function updateFees() {
            const amount = parseFloat(document.getElementById('transaction-amount').value) || 0;
            const gasFee = 0.50; // Fixed gas fee for simplicity
            const totalReceive = Math.max(0, amount - gasFee);

            document.getElementById('gas-fee').textContent = gasFee.toFixed(2);
            document.getElementById('total-receive').textContent = totalReceive.toFixed(2);
            document.getElementById('info-amount').textContent = `$${amount.toFixed(2)}`;

            updateSummary();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function () {
            const walletId = getOrCreateWalletId();
            document.getElementById('wallet-origin').textContent = walletId;

            // Auto-populate asset ID from URL params if available
            const urlParams = new URLSearchParams(window.location.search);
            const assetId = urlParams.get('asset') || urlParams.get('lote');
            if (assetId) {
                document.getElementById('asset-id').value = assetId;
            }

            // Add event listeners for real-time updates
            document.getElementById('transaction-amount').addEventListener('input', updateFees);
            document.getElementById('asset-id').addEventListener('input', updateSummary);
            document.getElementById('wallet-destination').addEventListener('input', updateSummary);
        });

        // Form submission handler
        document.getElementById('transaction-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const btnText = document.getElementById('btn-text');
            const btnSpinner = document.getElementById('btn-spinner');
            const alertBox = document.getElementById('alert-box');
            const submitBtn = e.target.querySelector('button[type="submit"]');

            // Collect form data
            const formData = {
                assetId: document.getElementById('asset-id').value,
                walletOrigin: document.getElementById('wallet-origin').textContent,
                walletDestination: document.getElementById('wallet-destination').value,
                transactionAmountUSD: parseFloat(document.getElementById('transaction-amount').value),
                digitalPin: document.getElementById('digital-pin').value,
                gasFee: parseFloat(document.getElementById('gas-fee').textContent),
                netAmount: parseFloat(document.getElementById('total-receive').textContent),
                tipoEvento: 'AssetTransfer',
                timestamp: new Date().toISOString()
            };

            // Validation
            if (formData.transactionAmountUSD <= 0) {
                alertBox.className = 'alert-box alert-error';
                alertBox.innerHTML = `
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>Error de Validación:</strong> El monto de la transacción debe ser mayor a $0.00
                `;
                alertBox.style.display = 'block';
                return;
            }

            if (formData.walletDestination.length < 20) {
                alertBox.className = 'alert-box alert-error';
                alertBox.innerHTML = `
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>Error de Validación:</strong> La dirección de wallet de destino no es válida
                `;
                alertBox.style.display = 'block';
                return;
            }

            if (formData.walletOrigin === formData.walletDestination) {
                alertBox.className = 'alert-box alert-error';
                alertBox.innerHTML = `
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>Error de Validación:</strong> No puede transferir a su propia wallet
                `;
                alertBox.style.display = 'block';
                return;
            }

            if (formData.digitalPin.length < 4) {
                alertBox.className = 'alert-box alert-error';
                alertBox.innerHTML = `
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>Error de Autenticación:</strong> El PIN debe tener al menos 4 caracteres
                `;
                alertBox.style.display = 'block';
                return;
            }

            // Disable button and show loading state
            submitBtn.disabled = true;
            btnText.textContent = 'Procesando Transacción...';
            btnSpinner.style.display = 'inline-block';
            alertBox.style.display = 'none';

            try {
                // Show warning during processing
                alertBox.className = 'alert-box alert-warning';
                alertBox.innerHTML = `
                    <i class="fas fa-hourglass-half mr-2"></i>
                    <strong>Procesando:</strong> Ejecutando Smart Contract de Escrow y registrando en blockchain...
                `;
                alertBox.style.display = 'block';

                // TODO: Replace with actual API endpoint
                // const response = await fetch('http://localhost:3000/api/transfer-asset', {
                //     method: 'POST',
                //     headers: {
                //         'Content-Type': 'application/json',
                //     },
                //     body: JSON.stringify(formData)
                // });

                // Simulate blockchain transaction processing
                await new Promise(resolve => setTimeout(resolve, 3000));

                // Generate transaction hash
                const txHash = '0x' + Array.from({ length: 64 }, () =>
                    Math.floor(Math.random() * 16).toString(16)
                ).join('');

                const blockNumber = Math.floor(Math.random() * 1000000) + 15000000;

                // Show success message
                alertBox.className = 'alert-box alert-success';
                alertBox.innerHTML = `
                    <div class="flex items-start">
                        <i class="fas fa-check-circle text-green-600 mr-3 mt-1 text-2xl"></i>
                        <div class="flex-1">
                            <strong class="text-lg">¡Transferencia Exitosa!</strong>
                            <ul class="mt-3 text-sm space-y-2">
                                <li class="flex justify-between">
                                    <span>Activo transferido:</span>
                                    <span class="font-semibold">${formData.assetId}</span>
                                </li>
                                <li class="flex justify-between">
                                    <span>Monto procesado:</span>
                                    <span class="font-semibold text-green-700">$${formData.transactionAmountUSD.toFixed(2)} USD</span>
                                </li>
                                <li class="flex justify-between">
                                    <span>Monto neto recibido:</span>
                                    <span class="font-semibold text-green-700">$${formData.netAmount.toFixed(2)} USD</span>
                                </li>
                                <li class="flex justify-between">
                                    <span>Nuevo propietario:</span>
                                    <span class="font-mono text-xs">${formData.walletDestination.substring(0, 15)}...</span>
                                </li>
                                <li class="flex justify-between">
                                    <span>Hash de transacción:</span>
                                    <span class="font-mono text-xs">${txHash.substring(0, 20)}...</span>
                                </li>
                                <li class="flex justify-between">
                                    <span>Bloque:</span>
                                    <span class="font-semibold">#${blockNumber}</span>
                                </li>
                                <li class="pt-2 border-t border-green-300">
                                    <span class="text-green-700">✓ Smart Contract de Escrow ejecutado</span>
                                </li>
                                <li>
                                    <span class="text-green-700">✓ Propiedad transferida en blockchain</span>
                                </li>
                                <li>
                                    <span class="text-green-700">✓ Pago procesado y confirmado</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                `;
                alertBox.style.display = 'block';

                // Reset form after 5 seconds
                setTimeout(() => {
                    if (confirm('¿Desea realizar otra transferencia?')) {
                        location.reload();
                    } else {
                        // Optionally redirect to wallet or dashboard
                        // window.location.href = 'wallet.html';
                    }
                }, 5000);

            } catch (error) {
                console.error('Error al procesar transferencia:', error);
                alertBox.className = 'alert-box alert-error';
                alertBox.innerHTML = `
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <strong>Error de Transacción:</strong> No se pudo completar la transferencia. 
                    Por favor, verifique su conexión y los datos ingresados, luego intente nuevamente.
                `;
                alertBox.style.display = 'block';
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                btnText.textContent = 'Ejecutar Transferencia Blockchain';
                btnSpinner.style.display = 'none';
            }
        });
    </script>
</body>

</html>